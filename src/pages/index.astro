---
import { getCollection } from "astro:content";
import RootLayout from "@/layouts/RootLayout.astro";
import SectionCard from "@/components/SectionCard.astro";
import Nav from "@/components/Nav.astro";
import Timeline from "@/components/Timeline/Timeline.astro";
import BlogCard from "@/components/BlogCard.astro";
import BlogModal from "@/components/react/BlogModal";

const allPosts = await getCollection("blog");
const latestPosts = allPosts
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime())
  .slice(0, 3);

// Prepare post data for React modal
const postsData = allPosts.map((post) => {
  const formattedDate = new Intl.DateTimeFormat("en-US", {
    year: "numeric",
    month: "long",
    day: "numeric",
  }).format(post.data.date);

  return {
    slug: post.slug,
    title: post.data.title,
    description: post.data.description,
    author: post.data.author,
    date: post.data.date.toISOString(),
    formattedDate,
  };
});

// Render content components server-side
const renderedPosts = await Promise.all(
  allPosts.map(async (post) => {
    const { Content } = await post.render();
    return { slug: post.slug, Content };
  }),
);
---

<RootLayout title="Gabriella Cardoso">
  <!-- <Nav /> -->
  <div class="flex flex-col">
    <SectionCard id="about">
      <h2>Hi there, I'm Gabriella</h2>
      <p class="text-xl">
        I'm living my dream fighting corruption, ensuring states independence/
        self suffiency not in depedency - strengthening communities through
        grassroots.
      </p>
    </SectionCard>
    <SectionCard>
      <h2>Bio</h2>
      <p>A short bio on me. Where I'm from, where I studied where I am now</p>
    </SectionCard>
    <SectionCard id="education">
      <h2>Education</h2>
      <Timeline
        items={[
          {
            title: "University name",
            description: "Description of what I studied",
            isCurrent: true,
          },
          {
            title: "University name",
            description: "Description of what I studied",
          },
          {
            title: "University name",
            description: "Description of what I studied",
          },
        ]}
      />
    </SectionCard>
    <SectionCard id="experience">
      <h2>My Work</h2>
      <strong>Project name</strong>
      <p>Description of what I did</p>
      <strong>Project name</strong>
      <p>Description of what I did</p>
      <strong>Project name</strong>
      <p>Description of what I did</p>
    </SectionCard>
    <SectionCard id="writing">
      <h2>Blog</h2>
      <div class="grid gap-md mb-md">
        {
          latestPosts.map((post) => (
            <BlogCard
              title={post.data.title}
              description={post.data.description}
              date={post.data.date}
              slug={post.slug}
            />
          ))
        }
      </div>
      <a
        href="/blog"
        class="inline-block text-blue-600 hover:text-blue-800 font-medium"
      >
        View all posts â†’
      </a>
    </SectionCard>
    <SectionCard id="skills">
      <h2>Skills</h2>
      <p>Coming soon. A place where I can show off my ideas</p>
      <!-- TODO: Is there a substack API for the CMS? -->
    </SectionCard>
    <SectionCard id="contact">
      <h2>Contact</h2>
      <p>Coming soon. A place where I can show off my ideas</p>
      <!-- TODO: Is there a substack API for the CMS? -->
    </SectionCard>
  </div>

  <!-- Hidden server-rendered blog content -->
  <div id="blog-content-store" class="hidden">
    {
      renderedPosts.map(({ slug, Content }) => (
        <div id={`blog-content-${slug}`} class="prose prose-lg max-w-none">
          <Content />
        </div>
      ))
    }
  </div>

  <!-- Blog Modal - React Component -->
  <BlogModal client:only="react" posts={postsData} />
</RootLayout>

<style>
  p:last-child {
    margin-bottom: 0;
  }
</style>
